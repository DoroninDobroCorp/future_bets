Отличная и очень логичная задача для развития проекта! Переход от парного анализа к "many-to-many" — это ключевой шаг к повышению эффективности и поиску большего количества выгодных ставок.
Это фундаментальное изменение, которое затронет ядро вашей системы. Давайте, используя наш README как карту, определим, какие части проекта необходимо будет изменить, а какие можно оставить без изменений на первом этапе.
Краткий вывод
Основная работа будет сосредоточена в двух местах:
livebet_backend-main/analyzer: Здесь находится вся логика поиска и расчета "вилок". Этот сервис нужно будет кардинально переделать.
admin_cli-main: Весь UI, который отображает пары и калькулятор, должен быть адаптирован под новую структуру данных (группа букмекеров, а не пара).
Детальный анализ изменений по компонентам
1. Сервис analyzer (Критически важно)
Это сердце изменений. Сейчас он находит пару матчей и сравнивает их. Новая логика должна быть такой:
Найти группу сопоставленных матчей (например, один и тот же матч у Pinnacle, Lobbet и Fonbet).
Для каждого возможного исхода (например, "Победа 1" или "Тотал > 2.5") найти самый высокий коэффициент среди всех букмекеров в этой группе.
Для противоположного исхода (например, "Ничья или Победа 2" или "Тотал < 2.5") также найти самый высокий коэффициент.
Рассчитать ROI, используя два лучших коэффициента от (возможно) двух разных букмекеров из группы.
Сформировать новый объект, который представляет эту "мульти-вилку" и отправить его на фронтенд.
Что это значит для кода:
internal/entity/pair.go: Структура ResponsePair, которая сейчас содержит First и Second, устареет. Нам понадобится новая структура, например, ValueOpportunity, которая будет содержать []ResponseMatch (срез матчей от всех букмекеров) и информацию о двух лучших коэффициентах, формирующих "вилку".
internal/service/pairs-matching.go: Основная логика в workerMatchData должна быть переписана. Вместо поиска одной пары (keyPair, ok := p.matchPairsCache.ReadKey(key)) нужно будет собирать целую группу сопоставленных матчей.
internal/service/findCommonOut.go: Функция findCommonOutcomes сейчас принимает данные от двух букмекеров. Её нужно будет переделать, чтобы она принимала срез данных от N букмекеров и находила лучшие коэффициенты.
internal/sender/sender.go: Будет отправлять на фронтенд уже не []entity.ResponsePair, а массив новых сущностей []ValueOpportunity.
2. Фронтенд admin_cli-main (Критически важно)
Фронтенд должен научиться принимать и отображать новую структуру данных.
interfaces/Pair.ts: Интерфейсы IPair и IPairOneOutcome нужно будет полностью переписать под новую сущность, которую будет присылать analyzer.
stores/PairStore.tsx и stores/PairPrematchStore.tsx: Логика effector-сторов изменится, так как они будут хранить не Map<string, IPair>, а новую структуру.
components/Match/Match.tsx: Этот компонент сейчас жестко завязан на pair.first и pair.second. Его нужно будет переделать, чтобы он мог отображать группу букмекеров и, возможно, подсвечивать тех, у кого лучшие коэффициенты.
components/Calculator/Calculator.tsx: Вместо пары он будет получать новую сущность. Он должен будет отображать двух букмекеров, чьи коэффициенты формируют "вилку", и корректно отправлять данные для логирования в tg_manager.
page-components/ClientPageComponent/ClientPageComponent.tsx: Здесь находится логика обработки сообщений с WebSocket. Функция parseAnalyzerMsg и последующая обработка данных потребуют изменений.
3. Другие сервисы (Второстепенное влияние)
calculator: Его API-ручка /calc-bet скорее всего принимает текущую структуру PairOneOutcome. Её нужно будет либо доработать, либо создать новую, чтобы она принимала новую "мульти-вилку".
tg_manager: Ручка /log_bet получает данные от фронтенда. Так как данные, передаваемые в калькулятор, изменятся, изменится и то, что отправляется в tg_manager. Возможно, понадобится доработка схемы таблицы calculator.log_bet_accept, чтобы хранить информацию о ставке в новом формате.
auto_matcher: На первом этапе его можно не трогать. Его задача — создавать сопоставления (пары). Сервис analyzer просто будет использовать эти сопоставления, чтобы строить группы из нескольких букмекеров.
Какие папки передавать, а какие пропустить
✅ Обязательно передать (здесь будут основные изменения):
livebet_backend-main/analyzer/: Полностью. Это ядро вашей новой логики.
admin_cli-main/: Полностью. Весь фронтенд нужно будет адаптировать под новые структуры данных и логику отображения.
livebet_backend-main/calculator/: Понадобится для изменения API и логики расчета.
livebet_backend-main/shared/: Здесь могут находиться общие структуры, которые тоже, возможно, придется изменить.
⚠️ Возможно, понадобятся позже (для полной интеграции):
livebet_backend-main/tg_manager/: Когда мы определимся с новой структурой ставки, нужно будет обновить ручку /log_bet и, возможно, модель AcceptBet.
livebet_backend-main/results/: После того как ставки в новом формате начнут логироваться, этому сервису нужно будет научиться их обрабатывать.
❌ Можно пропустить (эти части не затрагиваются):
livebet_backend-main/parse_* (все парсеры)
livebet_backend-main/runner/
livebet_backend-main/auto_matcher/ (на первом этапе)
livebet_backend-main/monitoring/
livebet_backend-main/statistic/
livebet_backend-main/tg_livebot/ и tg_testbot/
Все файлы .github/workflows/
Предлагаемый план действий
Чтобы задача не казалась огромной, предлагаю разбить ее на этапы:
Проектирование новой архитектуры analyzer'а:
Создаем новые структуры данных в analyzer/internal/entity/.
Переписываем логику в analyzer/internal/service/ для работы с группами букмекеров.
Убеждаемся, что analyzer корректно отправляет по WebSocket новую структуру.
Адаптация фронтенда admin_cli-main:
Обновляем интерфейсы и сторы в соответствии с новой структурой.
Переделываем компоненты Match и Calculator для отображения мульти-вилок.
Адаптируем страницу /client для корректной работы с новым потоком данных.
Интеграция смежных сервисов:
Обновляем API и логику в сервисе calculator.
Обновляем API и логику логирования в tg_manager.
Мы можем начать с первого этапа. Для этого мне будет достаточно полной папки livebet_backend-main/analyzer/. Как только мы закончим с ним, перейдем к фронтенду.