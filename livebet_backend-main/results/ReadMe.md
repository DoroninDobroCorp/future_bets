# Сервис обработки результатов ставок

Сервис для автоматического расчета результатов ставок на спортивные события.

## Возможности

- Работает непрерывно в фоновом режиме
- Автоматически запускает проверку результатов каждый день в 4:20 утра
- Сохраняет рассчитанные результаты (EV profit и real profit) в базу данных
- Интеграция с Telegram ботом для управления и уведомлений
- Подробное логирование в консоль и Telegram
- Поддержка тестовых ставок (отдельная таблица log_test_bet_accept)

## Установка и запуск

1. Клонировать репозиторий
2. Обновить параметры подключения в файле `.env`
3. Выполнить команду `go run cmd/main.go`

## Конфигурация

Параметры можно настроить в файле `.env`:

```
POSTGRES_HOST=188.253.24.91
POSTGRES_PORT=5432
POSTGRES_USERNAME=matchingTeams
POSTGRES_PASSWORD=local_password
POSTGRES_DB=matchingTeams
POSTGRES_SSLMODE=disable
TELEGRAM_BOT_TOKEN=8043106634:AAH0Q7l-bb4oODdmE_wzCMa-74xutgoG5EA
LOGS_ENABLED=true
```

## Telegram команды

Бот поддерживает следующие команды:

- `/process` - Запустить обработку результатов за последние 24 часа
- `/results <N> [bookmaker]` - Показать результаты за N дней (например: `/results 5 Lobbet`)
- `/results_test` - Показать результаты тестовых ставок за последние 7 дней
- `/date YYYY-MM-DD` - Обработать ставки за указанную дату
- `/date_test YYYY-MM-DD` - Обработать тестовые ставки за указанную дату
- `/edit <key>` - Обработать конкретную ставку по ключу
- `/fix` - Начать процесс исправления результатов матчей
- `/betedit <number>` - Редактировать ставку по её номеру в списке
- `/cancel` - Отменить текущую операцию
- `/help` - Показать справку

Также можно отправить следующие текстовые сообщения:
- `All` - Показать общие результаты за 30 дней
- `<N> <bookmaker>` - Показать результаты конкретного букмекера за N дней (например: `5 Lobbet`)

## Работа с тестовыми ставками

Тестовые ставки хранятся в отдельной таблице `Calculator.log_test_bet_accept`, имеющей структуру, аналогичную таблице обычных ставок. Для работы с тестовыми ставками реализованы:

1. Команда `/date_test YYYY-MM-DD` - позволяет обработать тестовые ставки за указанную дату
2. Команда `/results_test` - показывает статистику по тестовым ставкам за последние 7 дней

При обработке тестовых ставок система:
- Загружает ставки из таблицы `log_test_bet_accept`
- Позволяет вводить результаты матчей (счёт или W/L/D)
- Рассчитывает EV profit и real profit
- Сохраняет результаты в той же таблице
- Формирует статистику по букмекерам

## Алгоритм работы

1. При запуске сервис начинает работать в фоновом режиме
2. Каждые 45 секунд проверяется текущее время
3. В 4:20 утра запускается обработка результатов за прошедшие сутки
4. Результаты сохраняются в базу данных и отправляются в Telegram

## Функция Fix

Команда `/fix` выполняет следующие действия:
1. Находит все матчи с нерассчитанными результатами за последние 7 дней
2. Последовательно запрашивает у пользователя счет для каждого матча
3. После ввода счета рассчитывает прибыль и сохраняет в базу данных

## Разработка

Структура проекта:
- `cmd/` - Точка входа приложения
- `internal/` - Внутренняя логика приложения
  - `api/` - API модели
  - `calculator/` - Расчет результатов ставок
  - `entity/` - Бизнес-сущности
  - `repository/` - Работа с базой данных
  - `service/` - Бизнес-логика
- `configs/` - Конфигурационные файлы

LiveBets Results Processing System

Этот проект реализует систему обработки спортивных ставок. Основная идея заключается в следующем:
	•	Получение данных ставок из базы данных Postgres.
	•	Запрос данных матчей (fixtures) у API Pinnacle.
	•	Расчёт исхода ставки на основе заданных правил (например, простые исходы, хэндкап, тоталы, индивидуальные тоталы, ставки по таймам).
	•	Предоставление HTTP API для получения результата ставки или обработки группы ставок за определённый период.

Содержание
	1.	Обзор проекта
	2.	Структура проекта
	3.	Установка и настройка
	4.	Описание функционала
	•	cmd/main.go
	•	internal/repository
	•	internal/calculator
	•	internal/entity
	•	internal/api
	•	internal/service
	5.	API эндпоинты
	6.	Замечания и возможные улучшения
	7.	Заключение

Обзор проекта

Проект LiveBets Results Processing System создан для автоматизированной обработки спортивных ставок. Он сочетает в себе работу с базой данных и интеграцию с внешним API (Pinnacle), что позволяет:
	•	Считывать ставки из БД;
	•	Получать актуальные данные матчей через API;
	•	Вычислять итоговый исход ставки на основе логики расчёта (win, lose, void, unknown, error);
	•	Предоставлять HTTP эндпоинты для получения результатов.

Структура проекта

Проект организован следующим образом:
	•	results/
Содержит файлы зависимостей (go.mod, go.sum) и файлы окружения (.env).
	•	cmd/
	•	main.go – точка входа в приложение. Здесь происходит загрузка переменных окружения, подключение к базе данных, чтение конфигурации Pinnacle, инициализация сервисов и запуск обработки ставок.
	•	internal/
Содержит основную бизнес-логику:
	•	repository/
	•	postgres.go – функции для подключения к базе данных Postgres.
	•	bet_repository.go – функции для выборки ставок из таблицы (с десериализацией JSON-полей).
	•	calculator/
	•	outcome_calculator.go – набор функций для вычисления исхода ставки. Здесь реализована логика для:
	•	Простых исходов ("1", "2", "X").
	•	Хэндкап ставок (например, "H1+1.5").
	•	Тоталов (например, "T> 1.5").
	•	Индивидуальных тоталов (например, "IT1< 1.5").
	•	Ставок по таймам (с префиксами "P1" и "P2").
	•	Запроса результата у пользователя, если автоматическое определение невозможно.
	•	entity/
	•	bet.go – описание структуры ставки (LogBetAccept), содержащей ключи, данные (в виде map), процент и время создания.
	•	api/
	•	pinnacle_handler.go – HTTP-хендлеры для работы с API. Здесь реализованы эндпоинты для получения результата ставки по ключу и для запуска обработки последних ставок.
	•	model/
	•	fixture.go – определяет структуру Fixture (матча) и Period (периода), а также методы для получения финального счета и счета по конкретному периоду.
	•	service/
	•	pinnacle_service.go – реализует интеграцию с Pinnacle API. Настраивает HTTP-клиент с возможным использованием прокси, выполняет запрос к API и кэширует ответ для повторного использования.
	•	bet_service.go – объединяет логику работы с базой данных (repository) и PinnacleService. Обрабатывает отдельные ставки, рассчитывает итоговый исход и формирует сводку по букмекерам.
	  - telegram_service.go - реализует интеграцию с Telegram API для управления процессом обработки ставок через бота.
	•	configs/
	•	config.yml – YAML-конфигурация для Pinnacle API, включающая данные для аутентификации, настройки прокси, URL API, timeout и путь к эндпоинту для fixtures.

Установка и настройка

1. Установка зависимостей
	•	Убедитесь, что у вас установлен Go.
	•	В корневой директории проекта выполните команду:

go mod download

Это загрузит все необходимые зависимости.

2. Настройка переменных окружения

Файл .env

Содержит настройки подключения к базе данных и другие параметры:

DB_HOST=188.253.24.91
DB_PORT=5432
DB_USER=matchingTeams
DB_PASSWORD=local_password
DB_NAME=matchingTeams
DEFAULT_HOURS=24

Файл configs/config.yml

Содержит настройки для Pinnacle API:

pin:
  username: DS1666923
  password: '#$%1@2SA'
  proxy: socks5://AllivanService:All1vanProxy@172.84.179.181:5913
  api:
    url: https://api.pinnacle.com/
    timeout: 2
    fixtures_url: v1/fixtures/settled

3. Сборка и запуск
	•	Соберите проект (из папки с файлом main.go):

go build ./cmd


	•	Запустите скомпилированный бинарный файл:

./cmd

Описание функционала

cmd/main.go

Основной файл приложения, который:
	•	Определяет рабочую директорию и загружает файл .env.
	•	Подключается к базе данных с помощью функции NewPostgresClient из пакета repository.
	•	Читает конфигурацию Pinnacle из YAML (функция loadPinnConfig).
	•	Инициализирует PinnacleService и BetService.
	•	Считывает значение DEFAULT_HOURS для обработки ставок за последние N часов.
	•	Запускает обработку ставок через вызов ProcessRecentBets.
	•	Завершает выполнение приложения, освобождая порт.

internal/repository

postgres.go
	•	*NewPostgresClient(connStr string) (PostgresClient, error):
Открывает соединение с базой данных Postgres, проверяет его доступность (Ping) и возвращает экземпляр клиента.

bet_repository.go
	•	*GetRecentBets(hours int) ([]entity.LogBetAccept, error):
Вычисляет пороговую дату (текущее время минус указанное количество часов) и выполняет SQL-запрос для получения ставок, созданных после этой даты. Десериализует JSON-поля в map и возвращает срез ставок.
	•	*GetLogBetAcceptByKey(key string) (entity.LogBetAccept, error):
Получает конкретную ставку по уникальному ключу key_match и десериализует JSON-поля аналогично.
	•	*GetTestBetsByDateRange(startTime, endTime time.Time) ([]entity.LogBetAccept, error):
Получает тестовые ставки из таблицы log_test_bet_accept за указанный диапазон дат.
	•	*UpdateTestBetProfits(keyMatch string, evProfit, realProfit float64) error:
Обновляет значения ev_profit и real_profit для тестовой ставки.

internal/service/telegram_service.go

Реализует интеграцию с Telegram API:
	•	Команда /date_test - Обработка тестовых ставок за конкретную дату.
	•	Команда /results_test - Отображение статистики по тестовым ставкам.
	•	Флаг isTestBet - Определяет, что ожидается ввод для тестовой ставки.
	•	Функция processScoreInput - Обрабатывает ввод результатов как для обычных, так и для тестовых ставок.
	•	Функция showTestProcessingSummary - Показывает итоговую сводку по тестовым ставкам.

internal/service/bet_service.go

Расширен для обработки тестовых ставок:
	•	ProcessTestBetsByDate - Обрабатывает тестовые ставки за указанную дату.
	•	UpdateTestScoreManually - Обновляет счёт для тестовой ставки вручную.
	•	GetTestBookmakerSummary - Возвращает статистику по букмекерам для тестовых ставок.
	•	CalculateResultByScore - Определяет результат ставки на основе счёта.
	•	ExtractBetType - Извлекает тип ставки из данных ставки.
	•	ExtractBookmaker - Извлекает название букмекера из ставки.

Сборка и запуск
	•	Для сборки проекта выполните:

go build -o results ./cmd

	•	Для запуска выполните:

./results

Замечания и возможные улучшения
	•	Состояние проекта:
На данный момент система реализует основную функциональность: загрузку ставок, интеграцию с Pinnacle API, расчёт исходов и предоставление HTTP API. Код достаточно структурирован и разделён по ответственностям.
	•	Возможные улучшения:
	•	Тестирование: добавить юнит-тесты для всех основных функций (repository, calculator, service).
	•	Обработка ошибок: можно улучшить обработку ошибок, например, добавить более подробное логирование или систему уведомлений.
	•	Обновление кэша: реализовать механизм периодического обновления кэшированного ответа Pinnacle API.
	•	Производительность: рассмотреть возможность асинхронной обработки ставок для повышения производительности при большом объёме данных.
	•	Документация API: расширить описание HTTP эндпоинтов, добавить примеры запросов и ответов, а также схемы данных.
	•	Контейнеризация: добавить Dockerfile для упрощения деплоя приложения.

Заключение

Проект LiveBets Results Processing System демонстрирует комплексное решение для автоматизированной обработки ставок с использованием данных из Postgres и Pinnacle API. Код разделён на логически независимые слои (repository, service, api, calculator), что облегчает сопровождение и масштабирование системы.
В целом, проект выглядит завершённым для реализации базового функционала, однако всегда есть возможность для дальнейшего улучшения (тестирование, оптимизация, расширение функционала).

Надеюсь, этот README поможет вам разобраться в проекте и его возможностях. Если появятся вопросы или предложения, смело пишите – всегда рад помочь! 😊